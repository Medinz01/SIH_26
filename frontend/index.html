<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AyurFHIR Bridge - Terminology Search & Map</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* A little custom style for better UX */
        .search-results::-webkit-scrollbar { width: 8px; }
        .search-results::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px;}
        .search-results::-webkit-scrollbar-thumb { background: #888; border-radius: 10px;}
        .search-results::-webkit-scrollbar-thumb:hover { background: #555; }
        .result-item:hover { background-color: #eef2ff; }
        #mapping-result { display: none; } /* Hidden by default */
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-indigo-700">AyurFHIR Bridge</h1>
            <p class="text-lg text-gray-600 mt-2">Search and Map Medical Terminologies</p>
        </header>

        <!-- Search Section -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- NAMASTE Search Column -->
            <div>
                <label for="namaste-search" class="block text-sm font-medium text-gray-700 mb-1">NAMASTE (Ayurveda, Siddha, Unani)</label>
                <input type="text" id="namaste-search" data-system="namaste" placeholder="e.g., Jvara, Fever..." class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                <div id="namaste-results" class="search-results mt-2 h-64 overflow-y-auto bg-white rounded-md border border-gray-200"></div>
            </div>
            <!-- ICD-11 Search Column -->
            <div>
                <label for="icd11-search" class="block text-sm font-medium text-gray-700 mb-1">ICD-11</label>
                <input type="text" id="icd11-search" data-system="icd11" placeholder="e.g., Neoplasms, Injury..." class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                <div id="icd11-results" class="search-results mt-2 h-64 overflow-y-auto bg-white rounded-md border border-gray-200"></div>
            </div>
            <!-- LOINC Search Column -->
            <div>
                <label for="loinc-search" class="block text-sm font-medium text-gray-700 mb-1">LOINC</label>
                <input type="text" id="loinc-search" data-system="loinc" placeholder="e.g., Blood pressure, Glucose..." class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                <div id="loinc-results" class="search-results mt-2 h-64 overflow-y-auto bg-white rounded-md border border-gray-200"></div>
            </div>
        </div>

        <!-- Mapping Result Section -->
        <div id="mapping-result" class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
             <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Concept Map</h2>
             <div class="flex flex-col md:flex-row items-stretch justify-center gap-4">
                <!-- Source Term Card -->
                <div class="flex-1 bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                    <h3 class="font-bold text-indigo-800">Source Term (NAMASTE)</h3>
                    <p id="map-source-term" class="text-lg text-gray-900 mt-1"></p>
                    <p id="map-source-code" class="text-sm text-gray-500 font-mono"></p>
                    <p id="map-source-system" class="text-xs text-indigo-500 mt-1 capitalize"></p>
                </div>
                
                <!-- Arrow Icon -->
                <div class="flex items-center justify-center text-gray-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                    </svg>
                </div>

                <!-- Target Term Card -->
                <div class="flex-1 bg-green-50 p-4 rounded-lg border border-green-200">
                    <h3 class="font-bold text-green-800">Target Term (ICD-11)</h3>
                    <p id="map-target-term" class="text-lg text-gray-900 mt-1"></p>
                    <p id="map-target-code" class="text-sm text-gray-500 font-mono"></p>
                </div>
             </div>
             <p id="map-relationship" class="text-center text-sm text-gray-500 mt-4"></p>
        </div>
        <div id="mapping-not-found" class="hidden text-center text-gray-500 mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-md">
            No pre-defined map found for this term.
        </div>

    </div>

    <script>
        const inputs = document.querySelectorAll('input[type="text"]');
        
        // Debounce function to limit API calls while typing
        const debounce = (func, delay) => {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        };

        const search = async (system, query) => {
            const resultsContainer = document.getElementById(`${system}-results`);
            if (!query) {
                resultsContainer.innerHTML = '';
                return;
            }

            resultsContainer.innerHTML = '<div class="p-4 text-gray-500">Searching...</div>';
            
            try {
                const response = await fetch(`/search/${system}?term=${query}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();

                if (data.length === 0) {
                    resultsContainer.innerHTML = '<div class="p-4 text-gray-500">No results found.</div>';
                    return;
                }
                
                resultsContainer.innerHTML = data.map(item => `
                    <div class="result-item p-3 border-b border-gray-200 cursor-pointer" 
                         ${system === 'namaste' ? `onclick="fetchMap('${item.code}', '${item.system}')"` : ''}>
                        <p class="font-semibold text-gray-800">${item.term}</p>
                        <p class="text-sm text-gray-500 font-mono">${item.code} ${system === 'namaste' ? `<span class="capitalize text-indigo-600">(${item.system})</span>`: ''}</p>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Search error:', error);
                resultsContainer.innerHTML = '<div class="p-4 text-red-500">Error fetching results.</div>';
            }
        };

        const fetchMap = async (namasteCode, namasteSystem) => {
            const mappingResultDiv = document.getElementById('mapping-result');
            const notFoundDiv = document.getElementById('mapping-not-found');
            
            mappingResultDiv.style.display = 'none';
            notFoundDiv.classList.add('hidden');

            try {
                const response = await fetch(`/map?namaste_code=${encodeURIComponent(namasteCode)}&namaste_system=${encodeURIComponent(namasteSystem)}`);
                
                if (!response.ok) {
                     if(response.status === 404) {
                        notFoundDiv.classList.remove('hidden');
                     }
                     throw new Error('Mapping not found or server error');
                }

                const data = await response.json();
                
                // Populate and show the mapping card
                document.getElementById('map-source-term').textContent = data.source_term.term;
                document.getElementById('map-source-code').textContent = data.source_term.code;
                document.getElementById('map-source-system').textContent = data.source_term.system;

                if(data.target_term) {
                    document.getElementById('map-target-term').textContent = data.target_term.term;
                    document.getElementById('map-target-code').textContent = data.target_term.code;
                } else {
                    document.getElementById('map-target-term').textContent = 'N/A';
                    document.getElementById('map-target-code').textContent = 'N/A';
                }

                document.getElementById('map-relationship').textContent = `Relationship: ${data.map_relationship}`;

                mappingResultDiv.style.display = 'block';

            } catch (error) {
                console.error('Mapping fetch error:', error);
            }
        };

        inputs.forEach(input => {
            const debouncedSearch = debounce(search, 300);
            input.addEventListener('input', (e) => {
                const system = e.target.getAttribute('data-system');
                debouncedSearch(system, e.target.value);
            });
        });
    </script>
</body>
</html>

